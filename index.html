<html>
<head>
    <title>tank game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.2.4/pixi.min.js" integrity="sha512-Ch/O6kL8BqUwAfCF7Ie5SX1Hin+BJgYH4pNjRqXdTEqMsis1TUYg+j6nnI9uduPjGaj7DN4UKCZgpvoExt6dkw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
    <body>
        <script>
            //const app = new PIXI.Application({ background: '#1099bb', resizeTo: window });
            //document.body.appendChild(app.view);

            let myid = null;
            let renderer = null;
            let stage = null;
            let board = null;
            let tanks = {};
            const ws = new WebSocket("ws://74.208.107.245:32123");

            ws.addEventListener("open", () => {
                ws.send('{"id":0,"action":"NEW"}');
            });

            ws.addEventListener("message", (event) => {
                let rep = null;
                try {
                    rep = JSON.parse(event.data);
                } catch (e) {
                    console.log("invalid reply");
                    return;
                }

                if ("type" in rep) {
                    switch (rep.type) {
                        case "new":
                            myid = rep.id;
                            board = rep.board;
                            renderer = PIXI.autoDetectRenderer(rep.width, rep.height);
                            document.body.appendChild(renderer.view);
                            stage = new PIXI.Container();
                            renderer.render(stage);

                            ws.send('{"id":' + myid + ',"action":"C"}');
                            break;
                        case "tank":
                            if (!(rep.id in tanks)) {
                                let gr = new PIXI.Graphics();
                                gr.lineStyle(2, 0x993333);
                                gr.beginFill(0xFFFFFF);
                                gr.drawCircle(0, 0, 11);
                                gr.endFill();
                                let texture = renderer.generateTexture(gr);
                                tanks[rep.id] = new PIXI.Sprite(texture);  
                                stage.addChild(tanks[rep.id]);
                                renderer.render(stage);
                            }
                            tanks[rep.id].x = rep.x;
                            tanks[rep.id].y = rep.y;

                            break;
                        case "update":
                            break;
                        default: break;
                    }
                }
            });


            document.addEventListener("keydown", (event) => {
                let action = "";
                switch (event.keyCode) {
                    case 36:
                    case 103:
                        action = "NW";
                        break;
                    case 38:
                    case 104:
                        action = "N";
                        break;
                    case 33:
                    case 105:
                        action = "NE";
                        break;
                    case 39:
                    case 102:
                        action = "E";
                        break;
                    case 34:
                    case 99:
                        action = "SE";
                        break;
                    case 40:
                    case 98:
                        action = "S";
                        break;
                    case 35:
                    case 97:
                        action = "SW";
                        break;
                    case 37:
                    case 100:
                        action = "W";
                        break;
                    case 12:
                    case 101:
                        action = "C";
                        break;
                    case 65:
                        action = "L";
                        break;
                    case 68:
                        action = "R";
                        break;
                    default:
                        action = "";
                        break;
                }

                if (action != "") {
                    ws.send('{"id":' + myid + ',"action":"' + action + '"}');
                }
            }, false);

            
        </script>
    </body>
</html>

